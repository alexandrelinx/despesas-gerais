{% extends 'base.html' %}
{% block title %}Consumo de Combust√≠vel{% endblock %}
import zoomPlugin from 'chartjs-plugin-zoom';

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-start mb-3 flex-wrap">
 <h2 class="mb-0">Consumo de Combust√≠vel</h2> 
   <div class="text-end">
     <form method="get" class="row g-3 align-items-end justify-content-end mb-5 ">
      <div class="col-auto">
         <a href="{{ url_for('incluir_abastecimento') }}" class="btn btn-success align-self-end">
          <i class="fa-solid fa-plus"></i> Novo Abastecimento
        </a>
       </div>

     <div class="col-auto">
      
  <!---<a href="{{ url_for('exportar_csv') }}" target="_blank" class="btn btn-outline-secondary me-2">
    <i class="fa-regular fa-file-csv"></i> Exportar CSV
  </a> -->

        <a href="{{ url_for('exportar_pdf', mes=mes, ano=ano) }}" target="_blank" class="btn btn-outline-primary">
         <i class="fa-regular fa-file-pdf"></i> Exportar PDF
       </a>
    </div>

    <div class="col-auto">
      <label for="mes" class="form-label">M√™s</label>
      <select class="form-select" name="mes" id="mes">
        {% for m in range(1,13) %}
        <option value="{{ '%02d' % m }}" {% if mes == '%02d' % m %}selected{% endif %}>
          {{ '%02d' % m }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto">
      <label for="ano" class="form-label">Ano</label>
      <input type="text" class="form-control" name="ano" id="ano" value="{{ ano }}" placeholder="AAAA" maxlength="4" pattern="\d{4}">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
  </form>

  <h3 class="mb-1">Consumo do m√™s {{ mes }}/{{ ano }} ‚Äî M√©dia: {{ "%.3f"|format(media_consumo) }} km/L</h3>
  <div class="d-flex gap-3 justify-content-end flex-wrap">
  <p class="mb-0"><strong>Total abastecido em {{ ano }}:</strong> {{ "%.3f"|format(total_ano[0] or 0) }} L</p>
  <p class="mb-0"></p><strong>Total percorrido em {{ ano }}:</strong> {{ "%.2f"|format(total_ano[1] or 0) }} km</p>
  <p class="mb-0"><strong>Total pago em {{ ano }}:</strong> R$ {{ "%.2f"|format(total_ano[2] or 0) }}</p>
</div>
 </div>
</div>


  
<div class="row mb-3">
    <div class="col-lg-5 col-md-6">
<hr>
       
  <h5 class="mb-0">Gr√°fico de Consumo M√©dio Mensal</h5>   
   
</div> 
  <p class="mt-1"></p>
     <div class="mb-2">
      <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="alterarTipo('bar')">Barras</button>
      <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="alterarTipo('line')">Linha</button>
      <button class="btn btn-outline-success btn-sm me-2 mb-2" onclick="alternarPizza()">Pizza</button>
      <button class="btn btn-outline-success btn-sm me-2 mb-2" onclick="alternarRosca()">Rosca</button>
      <button class="btn btn-outline-secondary btn-sm mb-2" onclick="resetarZoom()">üîç Redefinir Zoom</button>
</div>

<!-- √Årea dos gr√°ficos -->
<div id="graficoWrapper" class="mt-3 mb-3" style="width: 400px;" >
  <canvas id="graficoConsumo" style="width:80%" height=auto></canvas>
</div>

<!-- Canvas separado para pizza e rosca -->
<div id="graficoPizzaWrapper" class="mt-3 mb-3" style="width: 400px;" >
  <canvas id="graficoPizza" style="width:70%" height=auto></canvas>
</div>

</div>



<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
  Chart.register(ChartZoom);

  let grafico;
  let graficoPizza;
  let tipoAtual = 'bar';
  let tipoPizzaAtual = null;

  function criarGrafico(tipo, data) {
    const ctx = document.getElementById('graficoConsumo').getContext('2d');
    if (grafico) grafico.destroy();

    grafico = new Chart(ctx, {
      type: tipo,
      data: {
        labels: data.labels,
        datasets: [{
          label: 'Consumo M√©dio (km/L)',
          data: data.valores,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: tipo === 'bar' || tipo === 'line' ? {
          y: { beginAtZero: true }
        } : {},
        plugins: {
          zoom: tipo === 'bar' || tipo === 'line' ? {
            pan: { enabled: true, mode: 'x' },
            zoom: {
              wheel: { enabled: true },
              pinch: { enabled: true },
              mode: 'x'
            }
          } : {}
        }
      }
    });
  }

  function criarGraficoPizza(tipo, data) {
    const ctx = document.getElementById('graficoPizza').getContext('2d');
    if (graficoPizza) graficoPizza.destroy();

    graficoPizza = new Chart(ctx, {
      type: tipo,
      data: {
        labels: data.labels,
        datasets: [{
          data: data.valores,
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
            '#9966FF', '#FF9F40', '#66BB6A', '#BA68C8',
            '#FF7043', '#29B6F6', '#FFA726', '#AB47BC'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: {
            display: true,
            text: tipo === 'pie' ? 'Gr√°fico de Pizza' : 'Gr√°fico de Rosca'
          }
        },
        cutout: tipo === 'doughnut' ? '50%' : 0
      }
    });
  }

  function alterarTipo(novoTipo) {
    tipoAtual = novoTipo;
    tipoPizzaAtual = null;
    document.getElementById('graficoWrapper').style.display = 'block';
    document.getElementById('graficoPizzaWrapper').style.display = 'none';

    fetch('/grafico/consumo')
      .then(res => res.json())
      .then(data => criarGrafico(novoTipo, data));
  }

  function alternarPizza() {
    tipoAtual = null;
    tipoPizzaAtual = 'pie';
    document.getElementById('graficoWrapper').style.display = 'none';
    document.getElementById('graficoPizzaWrapper').style.display = 'block';

    fetch('/grafico/consumo')
      .then(res => res.json())
      .then(data => criarGraficoPizza('pie', data));
  }

  function alternarRosca() {
    tipoAtual = null;
    tipoPizzaAtual = 'doughnut';
    document.getElementById('graficoWrapper').style.display = 'none';
    document.getElementById('graficoPizzaWrapper').style.display = 'block';

    fetch('/grafico/consumo')
      .then(res => res.json())
      .then(data => criarGraficoPizza('doughnut', data));
  }

  function resetarZoom() {
    if (grafico && (tipoAtual === 'bar' || tipoAtual === 'line')) {
      grafico.resetZoom();
    }
  }

  // Carregamento inicial
  fetch('/grafico/consumo')
    .then(res => res.json())
    .then(data => criarGrafico(tipoAtual, data));
</script>


<hr>


<table class="table table-striped table-hover mt-4 espacada">
  <thead class="table-light">
    <tr>
      <th scope="col">Data</th>
      <th scope="col">Quantidade (L)</th>
      <th scope="col">Kilometragem</th>
      <th scope="col">Pre√ßo por L</th>
      <th scope="col">Valor Pago</th>
      <th scope="col">Consumo (km/L)</th> <!-- NOVO -->
      <th scope="col" class="text-center">A√ß√µes</th>
    </tr>
  </thead>
  <tbody>
    {% for row in dados %}
    <tr>
      <td>{{ row['data_abastecimento'] }}</td>
      <td>{{ "%.3f"|format(row['quantidade']) }}</td>
      <td>{{ "%.2f"|format(row['kilometragem']) }}</td>
      <td>{{ "%.2f"|format(row['preco_litro']) }}</td>
      <td>{{ "%.2f"|format(row['valor_pago']) }}</td>
      <td>
         {% if row['consumo'] %}
           {{ "%.2f"|format(row['consumo']) }}
         {% else %}
           -
        {% endif %}
      </td> <!-- NOVO -->
      <td class="text-center">
        <a href="{{ url_for('editar_combustivel', id=row['id']) }}" class="btn btn-sm btn-outline-success me-1">
          <i class="fa-solid fa-pen-to-square"></i> Editar
        </a>
        <a href="{{ url_for('deletar_combustivel', id=row['id']) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Deseja excluir este registro?')">
          <i class="fa-solid fa-trash"></i> Excluir
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot class="table-light">
    <tr>
      <td><strong>Totais</strong></td>
      <td><strong>{{ "%.3f"|format(total_quantidade) }}</strong></td>
      <td><strong>{{ "%.2f"|format(total_km) }}</strong></td>
      <td></td>
      <td><strong>{{ "%.2f"|format(total_pago) }}</strong></td>
      <td><strong>{{ "%.3f"|format(media_consumo) }}</strong></td>
      <td></td>
    </tr>
  </tfoot>
</table>

<style>
  table.espacada {
    border-collapse: separate !important;
    border-spacing: 0.35rem 0.35rem;
  }

  table.espacada th,
  table.espacada td {
    padding-left: 1.25rem;
    padding-right: 1.25rem;
  }
</style>

{% endblock %}
