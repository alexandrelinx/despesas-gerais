{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<!-- CabeÃ§alho / AÃ§Ãµes -->
<div class="container-fluid px-0">
  <div class="row g-2 align-items-start mb-3">
    <!-- ESQUERDA: TÃ­tulo + Nova despesa + Intervalo -->
    <div class="col-12 col-md-7">
      <h2 class="mb-2">Resumo de Despesas</h2>
      <a href="/despesas" class="btn btn-primary btn-sm mb-2">+ Nova Despesa</a>

      <div class="d-flex flex-wrap align-items-center gap-2">
        <label for="intervalo-atualizacao" class="fw-bold text-dark mb-0">Atualizar a cada:</label>
        <select id="intervalo-atualizacao" class="form-select form-select-sm  w-auto">
          <option value="0">Nunca</option>
          <option value="10">10s</option>
          <option value="30">30s</option>
          <option value="60">1 min</option>
          <option value="300">5 min</option>
        </select>
      </div>
    </div>

    <!-- DIREITA: Filtro de MÃªs + Saldo -->
    <div class="col-12 col-md-5 text-md-end">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-start justify-content-md-end">
        <label for="mes-selecionado" class="mb-0">Despesas do MÃªs:</label>
        <select id="mes-selecionado" class="form-select form-select-sm w-100 w-auto"
                onchange="window.location.href='?mes=' + this.value;">
          {% for mes in colunas_meses_compradores %}
            <option value="{{ mes }}" {% if mes == mes_selecionado %}selected{% endif %}>{{ mes }}</option>
          {% endfor %}
        </select>

        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalSaldo">
          Saldo
        </button>
      </div>
    </div>
  </div>
</div>

{% block dashboard_saldo %}
<!-- Bootstrap CSS (caso o base.html nÃ£o traga) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">


<!-- Modal Saldo -->
<div class="modal fade" id="modalSaldo" tabindex="-1" aria-labelledby="modalSaldoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalSaldoLabel">Detalhes do Saldo â€” {{ mes_selecionado }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <h6 class="mb-2">CrÃ©ditos</h6>
        <p><strong>CrÃ©dito do SalÃ¡rio:</strong> R$ {{ '%.2f'|format(total_creditos_mes|default(0)) }}</p>
        <p><strong>CrÃ©dito dos Compradores:</strong> R$ {{ '%.2f'|format(credito_compradores|default(0)) }}</p>
        <p><strong>Total de CrÃ©ditos do MÃªs:</strong> R$ {{ '%.2f'|format(creditos_do_mes|default(0)) }}</p>

        <hr class="my-3">

        <h6 class="mb-2">Despesas</h6>
        <p><strong>Total Bandeiras (mÃªs):</strong> R$ {{ '%.2f'|format(total_bandeiras_mes|default(0)) }}</p>
        <p><strong>Total Outros (mÃªs):</strong> R$ {{ '%.2f'|format(total_outros_mes|default(0)) }}</p>
        <p><strong>Total das Despesas do MÃªs:</strong> R$ {{ '%.2f'|format(total_despesas_mes|default(0)) }}</p>

        <hr class="my-3">

        <h6 class="mb-2">Saldo</h6>
        <p><strong>Total Despesas do MÃªs:</strong> R$ {{ '%.2f'|format(total_despesas_mes|default(0)) }}</p>
        <p><strong>Total CrÃ©ditos do MÃªs:</strong> R$ {{ '%.2f'|format(creditos_do_mes|default(0)) }}</p>
        <p>
          <strong>Saldo:</strong>
          <span class="{% if saldo_mes == 0 %}saldo-zero{% elif saldo_mes > 0 %}saldo-positivo{% else %}saldo-negativo{% endif %}" style="font-weight:bold;">
            R$ {{ '%.2f'|format(saldo_mes|default(0)) }}
          </span>
        </p>
        <p><strong>Valor Pago:</strong> <span style="font-weight:bold; color:green;">R$ {{ '%.2f'|format(total_pago_mes|default(0)) }}</span></p>
        <p>
          <strong>Saldo Atualizado:</strong>
          <span class="{% if saldo_mes_ajustado == 0 %}saldo-zero{% elif saldo_mes_ajustado > 0 %}saldo-positivo{% else %}saldo-negativo{% endif %}" style="font-weight:bold;">
            R$ {{ '%.2f'|format(saldo_mes_ajustado|default(0)) }}
          </span>
        </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
<style>
  .modal-body p { margin-bottom: 0.75rem; }
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

<style>
  .dashboard-container {
    display: flex;
    flex-direction: column;
    height: 85vh;
    gap: 10px;
  }

  .secao {
    overflow: auto;
    padding: 10px;
    border: 1px solid #ddd;
    background-color: #fdfdfd;
  }

  .secao:not(.secao-parcelas):not(.secao-totais):not(.secao-totais-compradores):not(.secao-totais-outros) {
    flex: 1;
  }

  /* Altura fixa em desktop; em mobile serÃ¡ auto (ver @media) */
  .secao-parcelas { height: 850px; overflow-y: auto; flex: none; }
  .secao-totais   { height: 640px; overflow: auto; }
  .secao-totais-compradores { height: 760px; overflow: auto; }
  .secao-totais-outros { height: 450px; overflow: auto; }

  .pago {
    background-color: #d4edda !important;
    color: #155724 !important;
    font-weight: bold !important;
    cursor: pointer;
  }
  .pago-azul {
    background-color: #cce5ff !important;
    color: #004085 !important;
    font-weight: bold !important;
    cursor: pointer;
  }

  /* Scroll horizontal para tabelas */
  .scroll-container {
    overflow-x: auto;
    width: 100%;
    position: relative; /* necessÃ¡rio p/ sticky */
    -webkit-overflow-scrolling: touch; /* iOS */
    touch-action: pan-x;
  }
  .scroll-container table {
    min-width: max-content;
    border-collapse: collapse;
  }
  .scroll-container th,
  .scroll-container td {
    min-width: 120px;
    text-align: center;
    vertical-align: middle;
  }

  /* Sticky colunas (desktop) */
  .secao-totais .scroll-container th:first-child,
  .secao-totais .scroll-container td:first-child,
  .secao-totais-outros .scroll-container th:first-child,
  .secao-totais-outros .scroll-container td:first-child,
  .secao-totais-compradores .scroll-container th:first-child,
  .secao-totais-compradores .scroll-container td:first-child {
    position: sticky;
    left: 0;
    background-color: white;
    z-index: 5;
    border-right: 1px solid #dee2e6;
  }

  /* 2Âª coluna sticky apenas em "totais outros" (desktop) */
  .secao-totais-outros .scroll-container th:nth-child(2),
  .secao-totais-outros .scroll-container td:nth-child(2) {
    position: sticky;
    left: 320px;
    background-color: white;
    z-index: 4;
    border-right: 1px solid #dee2e6;
    min-width: 120px;
  }

  .table-sticky thead th:first-child {
    background-color: #343a40;
    color: white;
    z-index: 6;
  }
  .table-sticky thead th:nth-child(2) {
    background-color: #343a40;
    color: white;
    z-index: 5;
  }

  .nav-tabs .nav-link.active {
    background-color: #f8f9fa;
    font-weight: bold;
  }

  #intervalo-atualizacao { min-width: 100px; }

  .valor-oculto { opacity: 0; transition: opacity 0.3s ease; cursor: pointer; }
  .valor-oculto:hover { opacity: 1; }

  .saldo-zero { color: green !important; }
  .saldo-positivo { color: blue !important; }
  .saldo-negativo { color: red !important; }

  table.espacada { border-collapse: separate !important; border-spacing: 0.35rem 0.35rem; }
  table.espacada th, table.espacada td { padding-left: 1.25rem; padding-right: 1.25rem; }

  .secao-totais-outros table th:nth-child(2),
  .secao-totais-outros table td:nth-child(2) {
    width: 210px;
    min-width: 210px;
    max-width: 210px;
    white-space: nowrap;
  }

  .tabela-container {
    overflow-x: auto;
    max-width: 100%;
    position: relative;
  }

  /* Abas responsivas: rolagem horizontal em telas pequenas */
  .nav-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }
  .nav-tabs .nav-item { flex: 0 0 auto; }

  /* RESPONSIVO (telas pequenas) */
  @media (max-width: 768px) {
    .dashboard-container { height: auto; }
    .secao,
    .secao-parcelas,
    .secao-totais,
    .secao-totais-compradores,
    .secao-totais-outros {
      height: auto;
      max-height: 65vh; /* permite rolar a seÃ§Ã£o sem estourar a viewport */
    }

    /* Reduz largura mÃ­nima das colunas */
    .scroll-container th,
    .scroll-container td {
      min-width: 90px;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }

    /* Desativa 2Âª coluna sticky para evitar sobreposiÃ§Ãµes no mobile */
    .secao-totais-outros .scroll-container th:nth-child(2),
    .secao-totais-outros .scroll-container td:nth-child(2) {
      position: static !important;
      left: auto !important;
      z-index: auto !important;
    }

    /* Selects ocupam 100% da largura */
    #intervalo-atualizacao,
    #mes-selecionado {
      min-width: 0;
      width: 100%;
    }
     }

/* Por Comprador: alinhar valores Ã  direita e fixar o botÃ£o Ã  direita */
.secao-totais-compradores .scroll-container td.valor-mes-comprador,
.secao-totais-compradores .scroll-container td.valor-mes-comprador.text-center {
  position: relative;
  text-align: right !important;   /* anula .text-center e a regra global de td */
  padding-right: 30px;            /* reserva espaÃ§o fixo pro botÃ£o */
  white-space: nowrap;
  vertical-align: middle;
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum" 1, "lnum" 1;
}

/* BotÃ£o fixo na borda direita, fora do fluxo, nÃ£o empurra o texto */
.secao-totais-compradores .scroll-container td.valor-mes-comprador .btn-check-comprador {
  position: absolute !important;
  right: 8px !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  width: 20px !important;
  height: 20px !important;
  margin: 0 !important;
  padding: 0 !important;
  background: transparent !important;
  border: 0 !important;
  line-height: 1;
}
.secao-totais-compradores .scroll-container td.valor-mes-comprador .btn-check-comprador i {
  font-size: 16px;
}

/* Totais por Bandeira (valores nas colunas de meses + coluna Total) */
.secao-totais .scroll-container td.total-cell {
  text-align: right !important;
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum" 1, "lnum" 1;
}
.secao-totais .scroll-container tbody td:last-child {
  text-align: right !important;      /* coluna Total do corpo */
}
.secao-totais .scroll-container tfoot th:not(:first-child) {
  text-align: right !important;      /* totais do rodapÃ©, exceto "Total Geral" */
  white-space: nowrap;
}

/* Totais Outros (valores nas colunas de meses + coluna Total) */
.secao-totais-outros .scroll-container td.total-cell {
  text-align: right !important;
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum" 1, "lnum" 1;
}
.secao-totais-outros .scroll-container tbody td:last-child {
  text-align: right !important;      /* coluna Total do corpo */
}
.secao-totais-outros .scroll-container tfoot th:not(:first-child):not(:nth-child(2)) {
  text-align: right !important;      /* meses + total no rodapÃ© (pula 1Âª e 2Âª) */
  white-space: nowrap;
}



</style>

<!-- Abas -->
<ul class="nav nav-tabs mb-3 flex-nowrap overflow-auto" id="dashboardTabs" role="tablist" style="white-space: nowrap;">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="totais-tab" data-bs-toggle="tab" data-bs-target="#totais" type="button" role="tab">
      Totais por Bandeira
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="outros-tab" data-bs-toggle="tab" data-bs-target="#outros" type="button" role="tab">
      Totais Outros
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="compradores-tab" data-bs-toggle="tab" data-bs-target="#compradores" type="button" role="tab">
      Por Comprador
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="parcelas-tab" data-bs-toggle="tab" data-bs-target="#parcelas" type="button" role="tab">
      Parcelas
    </button>
  </li>
</ul>

<div class="tab-content dashboard-container">

  <!-- Parcelas Detalhadas -->
  <div class="tab-pane fade" id="parcelas" role="tabpanel" aria-labelledby="parcelas-tab">
    <div class="secao secao-parcelas">
      <h5>Parcelas Detalhadas</h5>
      <div class="scroll-container">
        <table class="table table-bordered table-sm table-hover parcelas-detalhadas espacada">
          <thead class="table-light">
            <tr>
              <th>Compra</th>
              <th>Estabelecimento</th>
              <th>Produto</th>
              <th>Bandeira</th>
              <th>Parcela</th>
              <th>Vencimento</th>
              <th>Valor da Parcela</th>
            </tr>
          </thead>
          <tbody>
            {% for p in parcelas %}
            <tr>
              <td>{{ p['data_compra'] }}</td>
              <td>{{ p['estabelecimento'] }}</td>
              <td>{{ p['produto_nome'] }}</td>
              <td>{{ p['bandeira_nome'] }}</td>
              <td>{{ p['numero_parcela'] }}/{{ p['total_parcelas'] }}</td>
              <td>{{ p['data_vencimento'].strftime('%d/%m/%Y') }}</td>
              <td class="{% if p['parcela_alterada'] %}text-primary fw-bold{% endif %}">
                R$ {{ '%.2f'|format(p['valor_parcela']) }}
                {% if p['parcela_alterada'] %}
                  <span title="Valor de parcela alterado">ðŸŸ¦</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Totais por MÃªs e Bandeira -->
  <div class="tab-pane fade show active" id="totais" role="tabpanel" aria-labelledby="totais-tab">
    <div class="secao secao-totais">
      <h5>Totais por MÃªs e Bandeira</h5>
      <div class="scroll-container">
        <table class="table table-striped table-bordered table-sm table-sticky espacada">
          <thead class="table-dark">
            <tr>
              <th class="bg-dark text-white">CartÃµes</th>
              {% for mes_ano in colunas_meses %}
              <th id="coluna_{{ mes_ano }}">{{ mes_ano }}</th>
              {% endfor %}
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for bandeira, valores in parcelas_por_mes.items() %}
            <tr>
              <td>{{ bandeira }}</td>
              {% for mes_ano in colunas_meses %}
                {% set valor = (valores[mes_ano] | float) if mes_ano in valores else 0 %}
                {% set pago = pagamento_por_mes_bandeira.get(bandeira, {}).get(mes_ano, False) %}
                <td role="button" tabindex="0"
                    class="text-center total-cell {% if pago %}pago{% endif %}"
                    data-bandeira="{{ bandeira }}" data-mes-ano="{{ mes_ano }}"
                    onclick="handleClick(this)"
                    ondblclick="handleDoubleClick(this)"
                    onkeypress="if(event.key === 'Enter' || event.key === ' ') {event.preventDefault();handleClick(this);}"
                    title="{% if pago %}Marcado como pago{% else %}Clique para marcar como pago{% endif %}"
                    style="cursor:pointer;">
                  R$ {{ '%.2f'|format(valor) }}
                </td>
              {% endfor %}
              <td>
                <strong><span class="valor-oculto">R$ {{ '%.2f'|format(totais_por_linha[bandeira]) }}</span></strong>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th>Total Geral</th>
              {% for mes_ano in colunas_meses %}
                <th><span class="valor-oculto">R$ {{ '%.2f'|format(totais_por_mes.get(mes_ano, 0)) }}</span></th>
              {% endfor %}
              <th><strong><span class="valor-oculto">R$ {{ '%.2f'|format(total_geral) }}</span></strong></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Totais Outros -->
  <div class="tab-pane fade" id="outros" role="tabpanel" aria-labelledby="outros-tab">
    <div class="secao secao-totais-outros">
      <h5>Totais por MÃªs e Bandeira (Outras Formas de Pagamento)</h5>
      <div class="scroll-container">
        <table class="table table-striped table-bordered table-sm table-sticky espacada">
          <thead class="table-dark">
            <tr>
              <th class="bg-dark text-white">Despesas Fixas</th>
              <th class="bg-dark text-white text-end">Tipo de Pagamento</th>
              {% for mes_ano in colunas_meses %}
              <th id="coluna_{{ mes_ano }}">{{ mes_ano }}</th>
              {% endfor %}
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for bandeira, valores in parcelas_por_mes_outros.items() %}
            <tr>
              <td>{{ bandeira }}</td>
              <td>{{ formas_pagamento_outros.get(bandeira, 'N/A') }}</td>
              {% for mes_ano in colunas_meses %}
                {% set valor = valores[mes_ano] if mes_ano in valores else 0 %}
                {% set valor_float = valor | float %}
                {% set pago = pagamento_por_mes_bandeira_outros.get(bandeira, {}).get(mes_ano, False) %}
                <td role="button" tabindex="0" class="text-center total-cell {% if pago %}pago{% endif %}"
                    data-bandeira="{{ bandeira }}" data-mes-ano="{{ mes_ano }}"
                    onclick="togglePagamento(this)"
                    onkeypress="if(event.key === 'Enter' || event.key === ' ') togglePagamento(this)"
                    title="{% if pago %}Marcado como pago{% else %}Clique para marcar como pago{% endif %}"
                    style="cursor:pointer;">
                  R$ {{ '%.2f'|format(valor_float) }}
                </td>
              {% endfor %}
              <td><strong><span class="valor-oculto">R$ {{ '%.2f'|format(totais_por_linha_outros[bandeira]) }}</span></strong></td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th>Total Geral</th>
              <th></th>
              {% for mes_ano in colunas_meses %}
              <th><span class="valor-oculto">R$ {{ '%.2f'|format(totais_por_mes_outros.get(mes_ano, 0)) }}</span></th>
              {% endfor %}
              <th><strong><span class="valor-oculto">R$ {{ '%.2f'|format(total_geral_outros) }}</span></strong></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Compradores -->
  <div class="tab-pane fade" id="compradores" role="tabpanel" aria-labelledby="compradores-tab">
    <div class="secao secao-totais-compradores">
      <h5>Totais por Comprador por MÃªs</h5>
      <div class="scroll-container">
        <table class="table table-striped table-bordered table-sm table-sticky espacada">
          <thead class="table-dark">
            <tr>
              <th class="bg-dark text-white">Compradores</th>
              {% for mes in colunas_meses_compradores %}
              <th id="coluna_{{ mes }}">{{ mes }}</th>
              {% endfor %}
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for comprador, valores in totais_por_comprador_mes.items() %}
            <tr>
              <td>{{ comprador }}</td>
              {% for mes in colunas_meses_compradores %}
                {% set valor = valores.get(mes, 0) %}
                {% set pago = pagamento_por_mes_comprador.get(comprador, {}).get(mes, False) %}
                <td class="valor-mes-comprador text-center {% if pago %}pago-azul{% endif %}"
                    data-comprador="{{ comprador }}" data-mes="{{ mes }}" style="cursor:pointer;"
                    title="{% if pago %}simPago{% else %}NÃ£o pago{% endif %}">
                  R$ {{ '%.2f'|format(valor) }}
                  <!-- BotÃ£o de marcaÃ§Ã£o visual -->
                  <button type="button"
                        class="btn btn-sm btn-link p-0 ms-2 btn-check-comprador"
                        title="Marcar como pago (visual)"
                        data-comprador="{{ comprador }}"
                        data-mes="{{ mes }}"
                        aria-label="Marcar {{ comprador }} em {{ mes }}">
                   <i class="bi bi-circle text-muted" aria-hidden="true"></i>
                   </button>
                </td>
              {% endfor %}
              <td><strong><span class="valor-oculto">R$ {{ '%.2f'|format(valores.values() | sum) }}</span></strong></td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th>Total Geral</th>
              {% for mes in colunas_meses_compradores %}
              <th><span class="valor-oculto">R$ {{ '%.2f'|format(totais_por_mes_comprador.get(mes, 0)) }}</span></th>
              {% endfor %}
              <th><strong><span class="valor-oculto">R$ {{ '%.2f'|format(total_geral_compradores) }}</span></strong></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

</div> <!-- fim tab-content -->

<script>
  const csrfToken = "{{ csrf_token }}";

  function togglePagamento(cell) {
    const bandeira = cell.dataset.bandeira;
    const mesAno = cell.dataset.mesAno;

    fetch('/toggle_pagamento', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ bandeira: bandeira, mes_ano: mesAno })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        const allCells = document.querySelectorAll(`td.total-cell[data-bandeira="${bandeira}"][data-mes-ano="${mesAno}"]`);
        allCells.forEach(c => {
          if (data.pago) {
            c.classList.add('pago');
            c.title = 'Marcado como pago';
          } else {
            c.classList.remove('pago');
            c.title = 'Clique para marcar como pago';
          }
        });
      } else {
        alert('Erro ao atualizar pagamento: ' + (data.error || ''));
      }
    })
    .catch(() => alert('Erro na comunicaÃ§Ã£o com o servidor'));
  }

  function mostrarDetalhesCompras(cell) {
    const bandeira = cell.dataset.bandeira;
    const mesAno = cell.dataset.mesAno;
    if (!bandeira || !mesAno) return;

    fetch('/detalhes_compras', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ bandeira, mes_ano: mesAno })
    })
    .then(response => {
      if (!response.ok) throw new Error("Erro ao buscar detalhes.");
      return response.json();
    })
    .then(data => {
      document.getElementById('modalDetalhesComprasLabel').textContent = `Detalhes da bandeira "${bandeira}" - ${mesAno}`;
      document.getElementById('totalMes').textContent = `Total do mÃªs: R$ ${data.total_mes.toFixed(2)}`;
      const tbody = document.getElementById('tbodyDetalhesCompras');
      tbody.innerHTML = '';
      data.detalhes.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.estabelecimento || '-'}</td>
          <td>${item.data_compra}</td>
          <td>R$ ${item.valor_compra.toFixed(2)}</td>
          <td>${item.quantidade_parcelas}</td>
          <td>${item.forma_pagamento || '-'}</td>
          <td>${item.bandeira || '-'}</td>
          <td>R$ ${item.valor_parcela_atual.toFixed(2)}</td>
          <td>${item.data_vencimento}</td>
          <td>${item.pago ? 'Sim' : 'NÃ£o'}</td>
        `;
        tbody.appendChild(tr);
      });

      const modalElement = document.getElementById('modalDetalhesCompras');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    })
    .catch(error => {
      alert("Erro ao buscar detalhes da compra.");
      console.error(error);
    });
  }

  function confirmarPagamento(cell) {
    const bandeira = cell.dataset.bandeira;
    const mesAno = cell.dataset.mesAno;
    const confirmacao = confirm(`Deseja realizar o pagamento da bandeira "${bandeira}" do mÃªs ${mesAno}?`);
    if (confirmacao) togglePagamento(cell);
  }

  // Scroll para o mÃªs atual
  function scrollParaMesAtualPorTexto(seletorSecao, colunasFixasInteiras = 2, colunasFixasParciais = 0) {
    const hoje = new Date();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const ano = hoje.getFullYear();
    const mesAno = `${mes}/${ano}`;

    const scrollContainer = document.querySelector(`${seletorSecao} .scroll-container`);
    if (!scrollContainer) return;
    const tabela = scrollContainer.querySelector('table');
    if (!tabela) return;

    const ths = tabela.querySelectorAll('thead th');
    let thAtual = null;
    ths.forEach(th => { if (th.textContent.trim() === mesAno) thAtual = th; });
    if (!thAtual) return;

    let larguraColunasFixas = 0;
    for (let i = 0; i < colunasFixasInteiras; i++) {
      if (ths[i]) larguraColunasFixas += ths[i].offsetWidth || 0;
    }
    if (colunasFixasParciais > 0 && (colunasFixasInteiras < ths.length)) {
      larguraColunasFixas += (ths[colunasFixasInteiras]?.offsetWidth || 0) * colunasFixasParciais;
    }

    const containerRect = scrollContainer.getBoundingClientRect();
    const thRect = thAtual.getBoundingClientRect();
    const deslocamento = scrollContainer.scrollLeft + (thRect.left - containerRect.left) - larguraColunasFixas;
    scrollContainer.scrollLeft = deslocamento > 0 ? deslocamento : 0;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const tabTotais = document.querySelector('#totais-tab');
    const tabOutros = document.querySelector('#outros-tab');
    const tabCompradores = document.querySelector('#compradores-tab');

    scrollParaMesAtualPorTexto('.secao-totais', 1, 0.04);
    scrollParaMesAtualPorTexto('.secao-totais-outros', 1, 0.87);
    scrollParaMesAtualPorTexto('.secao-totais-compradores', 1);

    tabTotais?.addEventListener('shown.bs.tab', () => scrollParaMesAtualPorTexto('.secao-totais', 1, 0.05));
    tabOutros?.addEventListener('shown.bs.tab', () => scrollParaMesAtualPorTexto('.secao-totais-outros', 1, 0.87));
    tabCompradores?.addEventListener('shown.bs.tab', () => scrollParaMesAtualPorTexto('.secao-totais-compradores', 1));
  });

  // AtualizaÃ§Ã£o automÃ¡tica (opcional)
  const tempoAtualizacao = {{ tempo_atualizacao | default(0) }} * 1000;
  if (tempoAtualizacao > 0) {
    setInterval(() => { atualizarDados(); }, tempoAtualizacao);
  } else {
    console.log("AtualizaÃ§Ã£o automÃ¡tica desabilitada (Nunca selecionado)");
  }
  function atualizarDados() {
    console.log("Atualizando dados...");
    fetch('/rota_de_atualizacao')
      .then(response => response.json())
      .then(data => { /* atualize elementos */ })
      .catch(console.error);
  }

  // PersistÃªncia do intervalo no localStorage
  const selectAtualizacao = document.getElementById('intervalo-atualizacao');
  const valorSalvo = localStorage.getItem('tempoAtualizacao') || "0";
  selectAtualizacao.value = valorSalvo;

  let intervalo = null;
  function iniciarAtualizacao(tempoSegundos) {
    if (intervalo) clearInterval(intervalo);
    if (tempoSegundos > 0) {
      intervalo = setInterval(() => { location.reload(); }, tempoSegundos * 1000);
    }
  }
  iniciarAtualizacao(parseInt(valorSalvo));

  selectAtualizacao.addEventListener('change', () => {
    const novoValor = selectAtualizacao.value;
    localStorage.setItem('tempoAtualizacao', novoValor);
    const url = new URL(window.location);
    url.searchParams.set('tempo_atualizacao', novoValor);
    window.location.href = url.toString();
  });

  // Clique e duplo clique
  let clickTimeout;
  function handleClick(element) {
    if (clickTimeout) { clearTimeout(clickTimeout); clickTimeout = null; }
    clickTimeout = setTimeout(() => {
      clickTimeout = null;
      mostrarDetalhesCompras(element);
    }, 300);
  }
  function handleDoubleClick(element) {
    if (clickTimeout) { clearTimeout(clickTimeout); clickTimeout = null; }
    confirmarPagamento(element);
  }
  window.handleClick = handleClick;
  window.handleDoubleClick = handleDoubleClick;


  // MarcaÃ§Ã£o visual por comprador e mÃªs
(function () {
  const keyFor = (comprador, mes) =>
    `${(comprador || '').trim()}__${(mes || '').trim()}`;

  function setIcon(btn, checked) {
    const icon = btn.querySelector('i');
    if (!icon) return;
    icon.classList.toggle('bi-check-circle-fill', checked);
    icon.classList.toggle('text-success', checked);
    icon.classList.toggle('bi-circle', !checked);
    icon.classList.toggle('text-muted', !checked);
    btn.title = checked ? 'Marcado como pago (visual)' : 'Marcar como pago (visual)';
    btn.dataset.checked = checked ? '1' : '0';
  }
  const isChecked = (btn) => btn.dataset.checked === '1';

  async function loadMarks() {
    try {
      const r = await fetch('/marcas_comprador_mes', {
        method: 'GET',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-CSRF-Token': csrfToken
        },
        credentials: 'same-origin',     // envia cookie de sessÃ£o
        cache: 'no-store'
      });
      if (!r.ok) throw new Error('HTTP ' + r.status + ': ' + (await r.text()));
      const { marks } = await r.json();

      document.querySelectorAll('.btn-check-comprador').forEach((btn) => {
        const key = keyFor(btn.dataset.comprador, btn.dataset.mes);
        setIcon(btn, !!(marks && marks[key]));
      });
    } catch (e) {
      console.error('Falha ao carregar marcaÃ§Ãµes dos compradores', e);
      document.querySelectorAll('.btn-check-comprador').forEach((btn) => setIcon(btn, false));
    }
  }

  async function toggleMark(btn) {
    const comprador = btn.dataset.comprador || '';
    const mes = btn.dataset.mes || '';
    const next = !isChecked(btn);

    btn.disabled = true;
    const previous = isChecked(btn);
    setIcon(btn, next); // UI otimista

    try {
      const r = await fetch('/marcas_comprador_mes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-CSRF-Token': csrfToken
        },
        credentials: 'same-origin',     // envia cookie de sessÃ£o
        body: JSON.stringify({ comprador, mes, marcado: next ? 1 : 0 })
      });
      if (!r.ok) {
        console.error('POST marcas HTTP', r.status, await r.text());
        setIcon(btn, previous); // reverte se falhar
      }
    } catch (e) {
      console.error('Falha ao salvar marcaÃ§Ã£o', e);
      setIcon(btn, previous);
    } finally {
      btn.disabled = false;
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadMarks();
    document.querySelectorAll('.btn-check-comprador').forEach((btn) => {
      btn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        toggleMark(btn);
      });
    });
  });
})();

</script>
























{% endblock %}
