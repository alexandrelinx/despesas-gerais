{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h2>Resumo de Despesas</h2>
<a href="/despesas" class="btn btn-primary mb-3">+ Nova Despesa</a>

<style>
.dashboard-container {
    display: flex;
    flex-direction: column;
    height: 85vh;
    gap: 10px;
}

.secao {
    flex: 1;
    overflow: auto;
    padding: 10px;
    border: 1px solid #ddd;
    background-color: #fdfdfd;
}

/* Classe para célula marcada como paga */
.pago {
    background-color: #d4edda !important;
    color: #155724 !important;
    font-weight: bold !important;
    cursor: pointer;
}
</style>

<div class="dashboard-container">

    <!-- ... demais seções ... -->
    <!-- Seção 1: Parcelas Detalhadas -->
    <div class="secao">
        <h5>Parcelas Detalhadas</h5>
        <table class="table table-bordered table-sm table-hover">
            <thead class="table-light">
                <tr>
                    <th>Compra</th>
                    <th>Estabelecimento</th>
                    <th>Produto</th>
                    <th>Bandeira</th>
                    <th>Parcela</th>
                    <th>Vencimento</th>
                    <th>Valor da Parcela</th>
                </tr>
            </thead>
            <tbody>
                {% for p in parcelas %}
                <tr>
                    <td>{{ p['data_compra'] }}</td>
                    <td>{{ p['estabelecimento'] }}</td>
                    <td>{{ p['produto_nome'] }}</td>
                    <td>{{ p['bandeira_nome'] }}</td>
                    <td>{{ p['numero_parcela'] }}/{{ p['total_parcelas'] }}</td>
                    <td>{{ p['data_vencimento'].strftime('%d/%m/%Y') }}</td>
                    <!--<td>R$ {{ '%.2f'|format(p['valor_parcela']) }}</td> -->
                    <td class="{% if p['parcela_alterada'] %}text-primary font-weight-bold{% endif %}">
                        R$ {{ '%.2f'|format(p['valor_parcela']) }}
                        {% if p['parcela_alterada'] %}
                           <span title="Valor de parcela alterado">🟦</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Seção 2: Totais por Mês e Bandeira -->
    <div class="secao">
        <h5>Totais por Mês e Bandeira</h5>
        <table class="table table-striped table-bordered table-sm">
            <thead class="table-dark">
                <tr>
                    <th>Bandeira</th>
                    {% for mes_ano in colunas_meses %}
                        <th>{{ mes_ano }}</th>
                    {% endfor %}
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for bandeira, valores in parcelas_por_mes.items() %}
                <tr>
                    <td>{{ bandeira }}</td>
                    {% set total_bandeira = 0 %}
                    {% for mes_ano in colunas_meses %}
                        {% set valor = valores[mes_ano] if mes_ano in valores else 0 %}
                        {% set total_bandeira = total_bandeira + valor %}
                        {% set pago = pagamento_por_mes_bandeira.get(bandeira, {}).get(mes_ano, False) %}
                        <td
                            class="text-center total-cell {% if pago %}pago{% endif %}"
                            data-bandeira="{{ bandeira }}"
                            data-mes-ano="{{ mes_ano }}"
                            onclick="togglePagamento(this)"
                            title="{% if pago %}Marcado como pago{% else %}Clique para marcar como pago{% endif %}"
                            style="cursor:pointer;"
                        >
                            R$ {{ '%.2f'|format(valor) }}
                        </td>
                    {% endfor %}
                    <td><strong>R$ {{ '%.2f'|format(total_bandeira) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-light">
                <tr>
                    <th>Total Geral</th>
                    {% for mes_ano in colunas_meses %}
                        <th>R$ {{ '%.2f'|format(totais_por_mes.get(mes_ano, 0)) }}</th>
                    {% endfor %}
                    <th><strong>R$ {{ '%.2f'|format(total_geral) }}</strong></th>
                </tr>
            </tfoot>
        </table>
    </div>

</div>

<script>

const csrfToken = "{{ csrf_token }}";


function togglePagamento(cell) {
    const bandeira = cell.dataset.bandeira;
    const mesAno = cell.dataset.mesAno;

     console.log("Toggle clicado: bandeira =", bandeira, ", mesAno =", mesAno);

    fetch('/toggle_pagamento', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ bandeira: bandeira, mes_ano: mesAno })
    })
   .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 🔁 Atualiza todas as células do mesmo grupo
            const allCells = document.querySelectorAll(`td.total-cell[data-bandeira="${bandeira}"][data-mes-ano="${mesAno}"]`);
            allCells.forEach(c => {
                if (data.pago) {
                    c.classList.add('pago');
                    c.title = 'Marcado como pago';
                } else {
                    c.classList.remove('pago');
                    c.title = 'Clique para marcar como pago';
                }
            });
        } else {
            alert('Erro ao atualizar pagamento: ' + (data.error || ''));
        }
    })
    .catch(() => alert('Erro na comunicação com o servidor'));
}
 </script>

{% endblock %}