{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h2>Resumo de Despesas</h2>
<a href="/despesas" class="btn btn-primary mb-3">+ Nova Despesa</a>

<style>
.dashboard-container {
    display: flex;
    flex-direction: column;
    height: 85vh;
    gap: 10px;
}

.secao {
    overflow: auto;
    padding: 10px;
    border: 1px solid #ddd;
    background-color: #fdfdfd;
}


.secao:not(.secao-parcelas):not(.secao-totais) {
    flex: 1;
}

.secao-parcelas {
    height: 150px;  /* altura fixa menor, ajuste conforme quiser */
    overflow-y: auto; /* mant√©m o scroll vertical */
    flex: none;
}

.secao-totais {
   /* flex-grow: 2; /* ocupa o dobro do espa√ßo em rela√ß√£o √†s outras com flex-grow 1 */
    height: 500px; /* aqui voc√™ coloca a altura que quiser */
    overflow: auto;
    padding: 10px;
    border: 1px solid #ddd;
    background-color: #fdfdfd;
}
/* Classe para c√©lula marcada como paga */
.pago {
    background-color: #d4edda !important;
    color: #155724 !important;
    font-weight: bold !important;
    cursor: pointer;
}

/* Scroll horizontal para tabelas largas */
.scroll-container {
    overflow-x: auto;
     width: 100%;
     position: relative; /* importante para sticky funcionar dentro */
}

.scroll-container table {
    min-width: max-content; 
     border-collapse: collapse;  /* for√ßa a tabela a ser "scroll√°vel" */
     
}

/* Fixar a primeira coluna */
.scroll-container th:first-child,
.scroll-container td:first-child {
    position: sticky;
    left: 0;
    background-color: white;
    z-index: 4;
    border-right: 1px solid #dee2e6;
}

/* Fixar a segunda coluna */
.scroll-container th:nth-child(2),
.scroll-container td:nth-child(2) {
    position: sticky;
    left: 214px; /* mesma largura da primeira coluna */
    background-color: white;
    z-index: 3; /* abaixo do cabe√ßalho mas acima do conte√∫do */
    border-right: 1px solid #dee2e6;
}

/* Para o cabe√ßalho da primeira coluna ficar acima das c√©lulas */
.table-sticky thead th:first-child {
    background-color: #343a40; 
    color: white; 
    z-index: 6;
}

/* Cabe√ßalho da segunda coluna sobreposta corretamente */
.table-sticky thead th:nth-child(2) {
    background-color: #343a40; 
    color: white; 
    z-index: 5;
}


/* Garantir largura m√≠nima razo√°vel para colunas */
.scroll-container th,
.scroll-container td {
    min-width: 120px;
    text-align: center;
}







</style>

<div class="dashboard-container">

    <!-- ... demais se√ß√µes ... -->
    <!-- Se√ß√£o 1: Parcelas Detalhadas -->
    <div class="secao secao-parcelas">
        <h5>Parcelas Detalhadas</h5>
        <table class="table table-bordered table-sm table-hover parcelas-detalhadas">
            <thead class="table-light">
                <tr>
                    <th>Compra</th>
                    <th>Estabelecimento</th>
                    <th>Produto</th>
                    <th>Bandeira</th>
                    <th>Parcela</th>
                    <th>Vencimento</th>
                    <th>Valor da Parcela</th>
                </tr>
            </thead>
            <tbody>
                {% for p in parcelas %}
                <tr>
                    <td>{{ p['data_compra'] }}</td>
                    <td>{{ p['estabelecimento'] }}</td>
                    <td>{{ p['produto_nome'] }}</td>
                    <td>{{ p['bandeira_nome'] }}</td>
                    <td>{{ p['numero_parcela'] }}/{{ p['total_parcelas'] }}</td>
                    <td>{{ p['data_vencimento'].strftime('%d/%m/%Y') }}</td>
                    <!--<td>R$ {{ '%.2f'|format(p['valor_parcela']) }}</td> -->
                    <td class="{% if p['parcela_alterada'] %}text-primary font-weight-bold{% endif %}">
                        R$ {{ '%.2f'|format(p['valor_parcela']) }}
                        {% if p['parcela_alterada'] %}
                           <span title="Valor de parcela alterado">üü¶</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Se√ß√£o 2: Totais por M√™s e Bandeira -->

    <div class="secao secao-totais">
        <h5>Totais por M√™s e Bandeira</h5>
        <div class="scroll-container">
            <table class="table table-striped table-bordered table-sm">
                <thead class="table-dark">
                  <tr>
                    <th>Bandeira</th>
                   {% for mes_ano in colunas_meses %}
                     <th id="coluna_{{ mes_ano }}">{{ mes_ano }}</th>
                   {% endfor %}
                   <th>Total</th>
                 </tr>
                </thead>
                <tbody>
                    {% for bandeira, valores in parcelas_por_mes.items() %}
                    <tr>
                        <td>{{ bandeira }}</td>
                   <!--     {% set total_bandeira = 0 %} -->
                        {% for mes_ano in colunas_meses %}
                            {% set valor = (valores[mes_ano] | float) if mes_ano in valores else 0 %}
                           <!-- {% set total_bandeira = total_bandeira + valor %}-->
                            {% set pago = pagamento_por_mes_bandeira.get(bandeira, {}).get(mes_ano, False) %}
                            <td
                               role="button"
                                tabindex="0"
                                class="text-center total-cell {% if pago %}pago{% endif %}"
                                data-bandeira="{{ bandeira }}"
                                data-mes-ano="{{ mes_ano }}"
                                onclick="togglePagamento(this)"
                                title="{% if pago %}Marcado como pago{% else %}Clique para marcar como pago{% endif %}"
                                style="cursor:pointer;"
                            >
                                R$ {{ '%.2f'|format(valor) }}
                            </td>
                        {% endfor %}
                         <td><strong>R$ {{ '%.2f'|format(totais_por_linha[bandeira]) }}</strong></td>
                      <!--   <td><strong>R$ {{ '%.2f'|format(total_bandeira) }}</strong></td> -->
                    </tr>
                    {% endfor %}
                   <script>
                   window.addEventListener('load', () => {
                     const scrollContainer = document.querySelector('.secao-totais .scroll-container');
                      if (scrollContainer) {
                       scrollContainer.scrollLeft = 480; // posi√ß√£o fixa que voc√™ quer
                       console.log('Scroll setado manualmente em 480');
                     }
                  });
                  </script>

                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>Total Geral</th>
                        {% for mes_ano in colunas_meses %}
                            <th>R$ {{ '%.2f'|format(totais_por_mes.get(mes_ano, 0)) }}</th>
                        {% endfor %}
                        <th><strong>R$ {{ '%.2f'|format(total_geral) }}</strong></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Se√ß√£o 3: Totais por M√™s e Bandeira (Sem Cart√£o de Cr√©dito) -->
    <div class="secao secao-totais-outros">
        <h5>Totais por M√™s e Bandeira (Outras Formas de Pagamento)</h5>
        <div class="scroll-container">
            <table class="table table-striped table-bordered table-sm  table-sticky">
                <thead class="table-dark">
                    <tr>
                       <th>Despesas</th>
                       <th>Pgto</th>
                       {% for mes_ano in colunas_meses %}
                         <th id="coluna_{{ mes_ano }}">{{ mes_ano }}</th>
                       {% endfor %}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bandeira, valores in parcelas_por_mes_outros.items() %}
                    <tr>
                        <td>{{ bandeira }}</td>
                        <td>{{ formas_pagamento_outros.get(bandeira, 'N/A') }}</td>
                       <!-- {% set total_bandeira = 0 %} -->
                        {% for mes_ano in colunas_meses %}
                            {% set valor = valores[mes_ano] if mes_ano in valores else 0 %}
                            {% set valor_float = valor | float %}
                         <!--  {% set total_bandeira = total_bandeira + valor_float %}-->
                            {% set pago = pagamento_por_mes_bandeira_outros.get(bandeira, {}).get(mes_ano, False) %}
                            <td
                                role="button"
                                tabindex="0"
                                class="text-center total-cell {% if pago %}pago{% endif %}"
                                data-bandeira="{{ bandeira }}"
                                data-mes-ano="{{ mes_ano }}"
                                onclick="togglePagamento(this)"
                                onkeypress="if(event.key === 'Enter' || event.key === ' ') togglePagamento(this)"
                                title="{% if pago %}Marcado como pago{% else %}Clique para marcar como pago{% endif %}"
                                style="cursor:pointer;"
                            >
                                R$ {{ '%.2f'|format(valor_float) }}
                            </td>
                        {% endfor %}
                          <td><strong>R$ {{ '%.2f'|format(totais_por_linha_outros[bandeira]) }}</strong></td>
                      <!--  <td><strong>R$ {{ '%.2f'|format(total_bandeira) }}</strong></td> -->
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>Total Geral</th>
                        <th></th>
                        {% for mes_ano in colunas_meses %}
                            <th>R$ {{ '%.2f'|format(totais_por_mes_outros.get(mes_ano, 0)) }}</th>
                        {% endfor %}
                        <th><strong>R$ {{ '%.2f'|format(total_geral_outros) }}</strong></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

</div>

<script>

const csrfToken = "{{ csrf_token }}";

function togglePagamento(cell) {
    const bandeira = cell.dataset.bandeira;
    const mesAno = cell.dataset.mesAno;

    console.log("Toggle clicado: bandeira =", bandeira, ", mesAno =", mesAno);

    fetch('/toggle_pagamento', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ bandeira: bandeira, mes_ano: mesAno })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualiza todas as c√©lulas do mesmo grupo
            const allCells = document.querySelectorAll(`td.total-cell[data-bandeira="${bandeira}"][data-mes-ano="${mesAno}"]`);
            allCells.forEach(c => {
                if (data.pago) {
                    c.classList.add('pago');
                    c.title = 'Marcado como pago';
                } else {
                    c.classList.remove('pago');
                    c.title = 'Clique para marcar como pago';
                }
            });
        } else {
            alert('Erro ao atualizar pagamento: ' + (data.error || ''));
        }
    })
    .catch(() => alert('Erro na comunica√ß√£o com o servidor'));
}

window.addEventListener('load', () => {
  const hoje = new Date();
  const mes = String(hoje.getMonth() + 1).padStart(2, '0'); // ex: "07"
  const ano = hoje.getFullYear();                            // ex: "2025"
  const mesAno = `${mes}/${ano}`;

  // Fun√ß√£o que posiciona scroll numa se√ß√£o pelo seletor CSS
  // colunasFixas: quantidade de colunas fixas antes dos meses (ex: 1 ou 2)
  function scrollParaMesAtual(seletorSecao, colunasFixas = 1) {
    const scrollContainer = document.querySelector(seletorSecao + ' .scroll-container');
    if (!scrollContainer) {
      console.log(`Scroll container n√£o encontrado para a se√ß√£o: ${seletorSecao}`);
      return;
    }

    const tabela = scrollContainer.querySelector('table');
    if (!tabela) {
      console.log('Tabela n√£o encontrada dentro do scroll container');
      return;
    }

    const ths = tabela.querySelectorAll('thead th');
    let indiceColuna = -1;

    ths.forEach((th, i) => {
      if (th.id === `coluna_${mesAno}`) {
        indiceColuna = i;
      }
    });

    if (indiceColuna === -1) {
      console.log(`Coluna ${mesAno} n√£o encontrada na se√ß√£o ${seletorSecao}.`);
      return;
    }

    const larguraColuna = 120; // conforme seu CSS
    const deslocamentoScroll = (indiceColuna - colunasFixas) * larguraColuna - 1;
    scrollContainer.scrollLeft = deslocamentoScroll;

    console.log(`Rolando para a coluna ${mesAno} na se√ß√£o ${seletorSecao}, √≠ndice ${indiceColuna}, scrollLeft ${deslocamentoScroll}`);
  }

  // Aplica o scroll nas duas se√ß√µes
  scrollParaMesAtual('.secao-totais', 1);          // Apenas a coluna Bandeira antes dos meses
  scrollParaMesAtual('.secao-totais-outros', 2);   // Bandeira + Forma de Pagamento antes dos meses
});


</script>

{% endblock %}
