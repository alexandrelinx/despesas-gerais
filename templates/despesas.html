{% extends "base.html" %}
{% block title %}Lançar Despesas{% endblock %}

{% block content %}
<h2>Lançar Nova Despesa</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<form method="post">
  <div class="row">
    <div class="col-md-6">
      <label>Estabelecimento</label>
      <select name="estabelecimento_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for e in estabelecimentos %}
          <option value="{{ e.id }}">{{ e.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Categoria</label>
      <select name="categoria_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for c in categorias %}
          <option value="{{ c.id }}">{{ c.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Local da Compra</label>
      <select name="local_compra_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for l in locais %}
          <option value="{{ l.id }}">{{ l.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Comprador</label>
      <select name="comprador_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for c in compradores %}
          <option value="{{ c.id }}">{{ c.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Produto</label>
      <select name="produto_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for p in produtos %}
          <option value="{{ p.id }}">{{ p.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Data da Compra</label>
      <input type="text" name="data_compra" class="form-control" required>
    </div>

    <div class="col-md-6">
      <label>Valor da Compra</label>
      <input type="number" step="0.01" name="valor_compra" class="form-control" required>
    </div>

    <div class="col-md-6">
      <label>Forma de Pagamento</label>
      <select name="forma_pagamento_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for f in formas %}
          <option value="{{ f.id }}">{{ f.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Bandeira</label>
      <select name="bandeira_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for b in bandeiras %}
          <option value="{{ b.id }}">{{ b.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Parcelamento</label>
      <select name="parcelamento_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for p in parcelamentos %}
          <option value="{{ p.id }}">{{ p.tipo }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Qtd Parcelas</label>
      <select name="quantidade_parcelas_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
      </select>
    </div>

    <div class="col-md-6">
      <label>Vencimento da Bandeira</label>
      <select name="vencimento_bandeira_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
      </select>
    </div>

    <div class="col-md-6">
      <label>Melhor dia de compra</label>
      <select name="melhor_dia_compra_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
      </select>
    </div>

    <div class="col-md-6">
      <label>Valor da Parcela</label>
      <input type="number" step="0.01" name="valor_parcela" class="form-control" required>
    </div>
  </div>

  <br>
  <button type="submit" class="btn btn-success">Salvar Lançamento</button>
</form>

<script>
// Dados das bandeiras: id -> vencimento, melhor dia compra e quantidade de parcelas
const bandeirasData = {
  {% for b in bandeiras %}
    "{{ b.id }}": {
      "vencimento": {{ b.vencimento | default(0, true) }},
      "melhorDia": {{ b.melhor_dia_compra | default(0, true) }},
      "quantidadeParcelas": {{ b.quantidade_parcelas | default(1, true) }}
    }{% if not loop.last %},{% endif %}
  {% endfor %}
};

const bandeiraSelect = document.querySelector('select[name="bandeira_id"]');
const vencimentoSelect = document.querySelector('select[name="vencimento_bandeira_id"]');
const melhorDiaSelect = document.querySelector('select[name="melhor_dia_compra_id"]');
const qtdParcelasSelect = document.querySelector('select[name="quantidade_parcelas_id"]');

// Preenche um select com opções numéricas de 1 até max (padrão 31)
function preencherSelectNumerico(select, max = 31) {
  select.innerHTML = '<option value="" disabled selected>Selecione</option>';
  for (let i = 1; i <= max; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    select.appendChild(option);
  }
}

// Inicializa selects com opções padrão
preencherSelectNumerico(vencimentoSelect);
preencherSelectNumerico(melhorDiaSelect);
preencherSelectNumerico(qtdParcelasSelect, 12);  // limite 12 parcelas, ajuste se quiser

function atualizarCampos() {
  const id = bandeiraSelect.value;
  if (id && bandeirasData[id]) {
    const dados = bandeirasData[id];

    vencimentoSelect.value = dados.vencimento || "";
    melhorDiaSelect.value = dados.melhorDia || "";

    preencherSelectNumerico(qtdParcelasSelect, 12);
    qtdParcelasSelect.value = dados.quantidadeParcelas || "";
  } else {
    vencimentoSelect.value = "";
    melhorDiaSelect.value = "";
    qtdParcelasSelect.value = "";
  }
}

bandeiraSelect.addEventListener('change', atualizarCampos);

// Se precisar preencher ao carregar a página (ex: edição), descomente a linha abaixo:
// atualizarCampos();

</script>
{% endblock %}
