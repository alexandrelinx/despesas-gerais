{% extends "base.html" %}
{% block title %}LanÃ§ar Despesas{% endblock %}
{% block content %}
<h2>LanÃ§ar Nova Despesa</h2>
<!-- {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %} -->

<form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
     <div class="row">
    <div class="col-md-6">
      <label>Estabelecimento</label>
      <select name="estabelecimento_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for e in estabelecimentos %}
        <option value="{{ e.id }}">{{ e.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Categoria</label>
      <select name="categoria_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for c in categorias %}
        <option value="{{ c.id }}">{{ c.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Local da Compra</label>
      <select name="local_compra_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for l in locais %}
        <option value="{{ l.id }}">{{ l.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Comprador</label>
      <select name="comprador_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for c in compradores %}
        <option value="{{ c.id }}">{{ c.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Produto</label>
      <select name="produto_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for p in produtos %}
        <option value="{{ p.id }}">{{ p.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Data da Compra</label>
        <input type="text" name="data_compra" id="data_do_credito" placeholder="dd/mm/aaaa" class="form-control"  required
            value="{{ registro.data_do_credito if registro else '' }}">
    </div>

    <div class="col-md-6">
      <label>Valor da Compra</label>
     <input type="text" name="valor_compra" class="form-control" required id="valor_compra">
    </div>

    <div class="col-md-6">
      <label>Forma de Pagamento</label>
      <select name="forma_pagamento_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for f in formas %}
        <option value="{{ f.id }}">{{ f.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Bandeira</label>
      <select name="bandeira_id" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for b in bandeiras %}
        <option value="{{ b.id }}">{{ b.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Parcelamento</label>
      <select name="parcelamento_id"  id="parcelamento" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for p in parcelamentos %}
        <option value="{{ p.id }}">{{ p.tipo }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Qtd Parcelas</label>
      <select name="quantidade_parcelas_id" id="quantidade_parcelas" class="form-control" required>
        <option value="" disabled selected>Selecione</option>
        {% for q in quantidades %}
        <option value="{{ q.id }}" {% if q.quantidade == 1 %}selected{% endif %}>{{ q.quantidade }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label>Valor da Parcela</label>
      <input type="number" step="0.01" name="valor_parcela" class="form-control" id="valor_parcela" required>
    </div>

   <div class="col-md-12">
      <label>ObservaÃ§Ã£o</label>
      <textarea name="observacao" class="form-control" rows="3" placeholder="Digite aqui alguma observaÃ§Ã£o..." autocorrect="on" autocapitalize="sentences" spellcheck="true">{{ request.form.observacao or '' }}</textarea>
  </div>

  </div>
  <br>
  <button type="submit"  class="btn btn-success">Salvar LanÃ§amento</button>
</form>

<!-- ðŸ”½ Scripts para a mÃ¡scara de data -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
  const input = document.getElementById('data_do_credito');

  input.addEventListener('input', function(e) {
    let value = input.value;

    // Remove tudo que nÃ£o for nÃºmero
    value = value.replace(/\D/g, '');

    // Limita o tamanho mÃ¡ximo para 8 dÃ­gitos (ddmmyyyy)
    if (value.length > 8) {
      value = value.slice(0,8);
    }

    // Insere as barras automaticamente
    if (value.length > 4) {
      // dd/mm/yyyy
      value = value.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3');
    } else if (value.length > 2) {
      // dd/mm
      value = value.replace(/(\d{2})(\d{1,2})/, '$1/$2');
    }

    input.value = value;
  });

   $(document).ready(function () {
    const inputData = document.getElementById('data_do_credito');
    const valorCompraInput = $('input[name="valor_compra"]');
    const parcelaInput = $('input[name="valor_parcela"]');
    const qtdParcelasSelect = $('#quantidade_parcelas');
    const parcelamentoSelect = $('#parcelamento');

    // ðŸ”¹ MÃ¡scara e formataÃ§Ã£o da data
    inputData.addEventListener('input', function () {
      let value = inputData.value.replace(/\D/g, '');

      if (value.length > 8) {
        value = value.slice(0, 8);
      }

      if (value.length > 4) {
        value = value.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3');
      } else if (value.length > 2) {
        value = value.replace(/(\d{2})(\d{1,2})/, '$1/$2');
      }

      inputData.value = value;
    });

    // ðŸ”¹ FunÃ§Ã£o para obter quantidade de parcelas (a partir do texto da opÃ§Ã£o)
    function getQtdParcelas() {
      const texto = qtdParcelasSelect.find('option:selected').text();
      return parseInt(texto) || 1;
    }

    // ðŸ”¹ FunÃ§Ã£o principal para calcular o valor da parcela
    function calcularParcela() {
      const valorCompra = parseFloat(valorCompraInput.val().replace(',', '.')) || 0;
      const qtdParcelas = getQtdParcelas();

      if (valorCompra > 0) {
        const valorParcela = (valorCompra / qtdParcelas).toFixed(2);
        parcelaInput.val(valorParcela);
      } else {
        parcelaInput.val('');
      }
    }

    // ðŸ”¹ Evento ao mudar o campo de parcelamento
    parcelamentoSelect.on('change', function () {
      const tipo = parcelamentoSelect.find('option:selected').text().trim();

      if (tipo === 'Sim') {
        qtdParcelasSelect.prop('disabled', false);
        parcelaInput.val(''); // Zera o valor da parcela
      } else {
        qtdParcelasSelect.prop('disabled', true);
        const valorUm = qtdParcelasSelect.find('option').filter(function () {
          return $(this).text().trim() === '1';
        }).val();
        qtdParcelasSelect.val(valorUm);
        calcularParcela();
      }
    });

    // ðŸ”¹ Eventos para recalcular valor da parcela
    valorCompraInput.on('input', calcularParcela);
    qtdParcelasSelect.on('change', calcularParcela);

// ðŸ”¹ Formatar valor da compra para exibir com 2 casas decimais ao sair do campo
    valorCompraInput.on('blur', function() {
      let val = $(this).val();
      if (val) {
        val = val.replace(',', '.');
        let num = parseFloat(val);
        if (!isNaN(num)) {
          $(this).val(num.toFixed(2).replace('.', ','));
        }
      }
    });



    // ðŸ”¹ Estado inicial: define "Parcelamento" como "NÃ£o", e "Qtd Parcelas" como 1 e desabilitado
    setTimeout(function () {
      const valorNao = parcelamentoSelect.find('option').filter(function () {
        return $(this).text().trim() === 'NÃ£o';
      }).val();

      if (valorNao) {
        parcelamentoSelect.val(valorNao).trigger('change');
      }
    }, 100);
  });

</script>



{% endblock %}
